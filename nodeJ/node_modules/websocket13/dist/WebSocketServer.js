"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const crypto_1 = require("crypto");
const permessage_deflate_1 = __importDefault(require("permessage-deflate"));
const tiny_typed_emitter_1 = require("tiny-typed-emitter");
const url_1 = require("url");
const websocket_extensions_1 = __importDefault(require("websocket-extensions"));
const WebSocketServerConnection_1 = __importDefault(require("./WebSocketServerConnection"));
const HTTPStatusCodes_1 = __importDefault(require("./enums/HTTPStatusCodes"));
const HTTP_VERSION = 1.1;
const WEBSOCKET_VERSION = 13;
// eslint-disable-next-line
const PACKAGE_VERSION = require('../package.json').version;
class WebSocketServer extends tiny_typed_emitter_1.TypedEmitter {
    constructor(options) {
        super();
        this.options = {
            pingInterval: 10000,
            pingTimeout: 10000,
            pingFailures: 3,
            permessageDeflate: true
        };
        options = options || {};
        Object.assign(this.options, options);
        this.protocols = this.options.protocols || [];
    }
    http(server) {
        server.on('upgrade', (req, socket, head) => {
            if (!req.headers.upgrade || req.headers.upgrade.toLowerCase() != 'websocket') {
                bail('Invalid upgrade type. Supported: websocket');
                return;
            }
            if (!req.headers.connection ||
                !req.headers.connection.toLowerCase().split(',').map(i => i.trim()).includes('upgrade')) {
                bail('Invalid upgrade request.');
                return;
            }
            let httpV = req.httpVersion.split('.');
            if (parseInt(httpV[0]) < 1 || parseInt(httpV[1]) < 1) {
                bail('Invalid HTTP version for websocket upgrade.');
                return;
            }
            if (req.method.toUpperCase() != 'GET') {
                bail('Bad HTTP method. Required: GET');
                return;
            }
            if (!req.headers['sec-websocket-key'] || Buffer.from(req.headers['sec-websocket-key'], 'base64').length != 16) {
                bail('Missing or invalid Sec-WebSocket-Key.');
                return;
            }
            if (req.headers['sec-websocket-version'] != WEBSOCKET_VERSION) {
                bail(`Sec-WebSocket-Version must be ${WEBSOCKET_VERSION}.`);
                return;
            }
            if (!socket.remoteAddress) {
                bail('Unable to determine IP address.');
                return;
            }
            let selectedProtocol = null;
            let protocols = [];
            if (req.headers['sec-websocket-protocol']) {
                protocols = req.headers['sec-websocket-protocol'].split(',').map(protocol => protocol.trim());
                // Do any of these match?
                for (let i = 0; i < protocols.length; i++) {
                    if (this.protocols.indexOf(protocols[i]) != -1) {
                        selectedProtocol = protocols[i];
                        break;
                    }
                }
            }
            let uri = (0, url_1.parse)(req.url, true);
            let extensions = new websocket_extensions_1.default();
            if (this.options.permessageDeflate) {
                extensions.add(permessage_deflate_1.default);
            }
            let selectedExtensions = extensions.generateResponse(req.headers['sec-websocket-extensions']);
            let handshakeData = {
                path: uri.pathname,
                query: uri.query,
                headers: req.headers,
                httpVersion: req.httpVersion,
                origin: req.headers.origin || null,
                protocols: protocols || [],
                selectedProtocol: selectedProtocol || null,
                auth: null,
                cookies: {},
                remoteAddress: socket.remoteAddress.replace(/^::ffff:/, ''),
                socket
            };
            // Does it have HTTP authorization?
            if (req.headers.authorization) {
                let match = req.headers.authorization.match(/basic ((?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4}))/i);
                if (match) {
                    handshakeData.auth = Buffer.from(match[1], 'base64').toString('utf8');
                }
            }
            // Does it have cookies?
            if (req.headers.cookie) {
                req.headers.cookie.split(';').map(cookie => cookie.trim().split('=')).forEach(cookie => {
                    handshakeData.cookies[cookie[0].trim()] = decodeURIComponent(cookie.slice(1).join('=').trim());
                });
            }
            // Everything looks okay so far, make sure we'd like to accept this.
            this.emit('handshake', handshakeData, (statusCode, body, headers) => {
                // REJECT
                req.statusCode = statusCode || 403;
                headers = headers || {};
                socket.end(buildResponse(statusCode || 403, headers, body));
            }, (response) => {
                // ACCEPT
                response = response || {};
                let headers = response.headers || {};
                let options = {
                    pingInterval: this.options.pingInterval,
                    pingTimeout: this.options.pingTimeout,
                    pingFailures: this.options.pingFailures,
                };
                headers.Upgrade = 'websocket';
                headers.Connection = 'Upgrade';
                headers['Sec-WebSocket-Accept'] = (0, crypto_1.createHash)('sha1').update(req.headers['sec-websocket-key'] + '258EAFA5-E914-47DA-95CA-C5AB0DC85B11').digest('base64');
                // Check if the accept method overrode our selected subprotocol
                if (typeof response.protocol !== 'undefined') {
                    handshakeData.selectedProtocol = response.protocol || null;
                }
                if (typeof response.permessageDeflate != 'undefined') {
                    extensions = new websocket_extensions_1.default();
                    if (response.permessageDeflate) {
                        extensions.add(permessage_deflate_1.default);
                    }
                    selectedExtensions = extensions.generateResponse(req.headers['sec-websocket-extensions']);
                }
                if (selectedExtensions) {
                    headers['Sec-WebSocket-Extensions'] = selectedExtensions;
                }
                if (handshakeData.selectedProtocol) {
                    headers['Sec-WebSocket-Protocol'] = handshakeData.selectedProtocol;
                }
                socket.write(buildResponse(101, headers));
                response.options = response.options || {};
                Object.assign(options, response.options);
                let websocket = new WebSocketServerConnection_1.default(socket, options, handshakeData, head, extensions);
                this.emit('connection', websocket);
                return websocket;
            });
            function bail(err) {
                if (server.listenerCount('upgrade') != 1) {
                    // Something else could pick this up
                    return;
                }
                socket.end(buildResponse(400, null, err));
            }
        });
    }
}
exports.default = WebSocketServer;
function buildResponse(code, headers, body) {
    let response = `HTTP/${HTTP_VERSION} ${code} ${HTTPStatusCodes_1.default[code] || 'Unknown Response'}\r\n`;
    headers = headers || {};
    headers.Server = `node-websocket13/${PACKAGE_VERSION}`;
    headers.Date = new Date().toUTCString();
    if (typeof body === 'object') {
        body = JSON.stringify(body);
        headers['Content-Type'] = 'application/json';
    }
    if (body) {
        headers['Content-Length'] = Buffer.byteLength(body);
    }
    else if (code != 204 && code != 101) {
        headers['Content-Length'] = 0;
    }
    for (let i in headers) {
        response += `${i}: ${headers[i]}\r\n`;
    }
    response += '\r\n' + (typeof body !== 'undefined' ? body : '');
    return response;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2ViU29ja2V0U2VydmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL1dlYlNvY2tldFNlcnZlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLG1DQUFrQztBQUdsQyw0RUFBbUQ7QUFDbkQsMkRBQWdEO0FBQ2hELDZCQUFzQztBQUN0QyxnRkFBdUQ7QUFHdkQsNEZBQW9FO0FBQ3BFLDhFQUFzRDtBQUd0RCxNQUFNLFlBQVksR0FBRyxHQUFHLENBQUM7QUFDekIsTUFBTSxpQkFBaUIsR0FBRyxFQUFFLENBQUM7QUFFN0IsMkJBQTJCO0FBQzNCLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLE9BQU8sQ0FBQztBQUUzRCxNQUFxQixlQUFnQixTQUFRLGlDQUFtQztJQUkvRSxZQUFZLE9BQWdDO1FBQzNDLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLE9BQU8sR0FBRztZQUNkLFlBQVksRUFBRSxLQUFLO1lBQ25CLFdBQVcsRUFBRSxLQUFLO1lBQ2xCLFlBQVksRUFBRSxDQUFDO1lBQ2YsaUJBQWlCLEVBQUUsSUFBSTtTQUN2QixDQUFDO1FBRUYsT0FBTyxHQUFHLE9BQU8sSUFBSSxFQUFFLENBQUM7UUFDeEIsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBRXJDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLElBQUksRUFBRSxDQUFDO0lBQy9DLENBQUM7SUFFRCxJQUFJLENBQUMsTUFBa0I7UUFDdEIsTUFBTSxDQUFDLEVBQUUsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxHQUFvQixFQUFFLE1BQWMsRUFBRSxJQUFZLEVBQUUsRUFBRTtZQUMzRSxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLElBQUksR0FBRyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLElBQUks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