"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
/**
 * Return a new promise that will automatically be rejected with 'Error: Request timed out' after a specified timeout period
 * @param {number} timeout - Timeout in milliseconds. If this value is <= 0, then the timeout functionality is disabled.
 * @param {function} executor
 * @returns {Promise}
 */
function timeoutPromise(timeout, executor) {
    // We have to create the Error here in order to have a useful stack trace.
    // If we create it inside of the timer callback, we don't get anything helpful.
    let err = new Error('Request timed out');
    return new Promise((resolve, reject) => {
        let timedOut = false;
        let timer = null;
        if (timeout > 0) {
            timer = setTimeout(() => {
                timedOut = true;
                reject(err);
            }, timeout);
        }
        try {
            let executorReturn = executor((resolveValue) => {
                // resolve() was called inside the executor
                if (!timedOut) {
                    clearTimeout(timer);
                    resolve(resolveValue);
                }
            }, (rejectValue) => {
                // reject() was called inside the executor
                if (!timedOut) {
                    clearTimeout(timer);
                    reject(rejectValue);
                }
            });
            if (typeof executorReturn == 'object' && executorReturn !== null && typeof executorReturn.catch == 'function') {
                // It's an async function
                executorReturn.catch((ex) => {
                    // The executor is an async function and it was rejected (e.g. new Promise(async (resolve, reject) => { }))
                    if (!timedOut) {
                        clearTimeout(timer);
                        reject(ex);
                    }
                });
            }
        }
        catch (ex) {
            if (!timedOut) {
                // The executor is not an async function, and something threw inside of it
                clearTimeout(timer);
                reject(ex);
            }
        }
    });
}
exports.default = timeoutPromise;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZW91dFByb21pc2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL3Byb21pc2VzL3RpbWVvdXRQcm9taXNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7O0dBS0c7QUFDSCxTQUF3QixjQUFjLENBQ3JDLE9BQWUsRUFDZixRQUdRO0lBRVIsMEVBQTBFO0lBQzFFLCtFQUErRTtJQUMvRSxJQUFJLEdBQUcsR0FBRyxJQUFJLEtBQUssQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBRXpDLE9BQU8sSUFBSSxPQUFPLENBQUMsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLEVBQUU7UUFDdEMsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztRQUVqQixJQUFJLE9BQU8sR0FBRyxDQUFDLEVBQUU7WUFDaEIsS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUU7Z0JBQ3ZCLFFBQVEsR0FBRyxJQUFJLENBQUM7Z0JBQ2hCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNiLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztTQUNaO1FBRUQsSUFBSTtZQUNILElBQUksY0FBYyxHQUFHLFFBQVEsQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFO2dCQUM5QywyQ0FBMkM7Z0JBQzNDLElBQUksQ0FBQyxRQUFRLEVBQUU7b0JBQ2QsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUNwQixPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7aUJBQ3RCO1lBQ0YsQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFLEVBQUU7Z0JBQ2xCLDBDQUEwQztnQkFDMUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtvQkFDZCxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7b0JBQ3BCLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQztpQkFDcEI7WUFDRixDQUFDLENBQUMsQ0FBQztZQUVILElBQUksT0FBTyxjQUFjLElBQUksUUFBUSxJQUFJLGNBQWMsS0FBSyxJQUFJLElBQUksT0FBTyxjQUFjLENBQUMsS0FBSyxJQUFJLFVBQVUsRUFBRTtnQkFDOUcseUJBQXlCO2dCQUN6QixjQUFjLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUU7b0JBQzNCLDJHQUEyRztvQkFDM0csSUFBSSxDQUFDLFFBQVEsRUFBRTt3QkFDZCxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7d0JBQ3BCLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQztxQkFDWDtnQkFDRixDQUFDLENBQUMsQ0FBQzthQUNIO1NBQ0Q7UUFBQyxPQUFPLEVBQUUsRUFBRTtZQUNaLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2QsMEVBQTBFO2dCQUMxRSxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ3BCLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQzthQUNYO1NBQ0Q7SUFDRixDQUFDLENBQUMsQ0FBQztBQUNKLENBQUM7QUF2REQsaUNBdURDIn0=