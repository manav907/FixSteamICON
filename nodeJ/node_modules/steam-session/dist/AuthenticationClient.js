"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const http_1 = require("@doctormckay/stdlib/http");
const debug_1 = __importDefault(require("debug"));
const events_1 = require("events");
const node_bignumber_1 = require("node-bignumber");
const querystring_1 = require("querystring");
const timers_1 = require("timers");
const EAuthTokenPlatformType_1 = __importDefault(require("./enums-steam/EAuthTokenPlatformType"));
const EOSType_1 = __importDefault(require("./enums-steam/EOSType"));
const EResult_1 = __importDefault(require("./enums-steam/EResult"));
const ESessionPersistence_1 = __importDefault(require("./enums-steam/ESessionPersistence"));
const ETokenRenewalType_1 = __importDefault(require("./enums-steam/ETokenRenewalType"));
const protobufs_1 = require("./protobufs");
const helpers_1 = require("./helpers");
const debug = (0, debug_1.default)('steam-session:AuthenticationClient');
class AuthenticationClient extends events_1.EventEmitter {
    constructor(options) {
        super();
        this._transport = options.transport;
        this._platformType = options.platformType;
        this._webClient = options.webClient;
        this._webUserAgent = options.webUserAgent;
        if (this._platformType == EAuthTokenPlatformType_1.default.WebBrowser) {
            this._webClient.userAgent = options.webUserAgent;
        }
        this._machineId = options.machineId;
    }
    async getRsaKey(accountName) {
        return await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'GetPasswordRSAPublicKey',
            apiVersion: 1,
            data: { account_name: accountName }
        });
    }
    async encryptPassword(accountName, password) {
        let rsaInfo = await this.getRsaKey(accountName);
        let key = new node_bignumber_1.Key();
        key.setPublic(rsaInfo.publickey_mod, rsaInfo.publickey_exp);
        return {
            encryptedPassword: (0, node_bignumber_1.hex2b64)(key.encrypt(password)),
            keyTimestamp: rsaInfo.timestamp
        };
    }
    async startSessionWithCredentials(details) {
        let { websiteId, deviceDetails } = this._getPlatformData();
        let data = {
            account_name: details.accountName,
            encrypted_password: details.encryptedPassword,
            encryption_timestamp: details.keyTimestamp,
            remember_login: details.persistence == ESessionPersistence_1.default.Persistent,
            persistence: details.persistence,
            website_id: websiteId,
            device_details: deviceDetails
        };
        if (details.platformType == EAuthTokenPlatformType_1.default.SteamClient) {
            // For SteamClient logins, we also need a machine id
            if (this._machineId && Buffer.isBuffer(this._machineId)) {
                data.device_details.machine_id = this._machineId;
            }
            else if (this._machineId === true) {
                data.device_details.machine_id = (0, helpers_1.createMachineId)(details.accountName);
            }
        }
        if (details.steamGuardMachineToken) {
            if (Buffer.isBuffer(details.steamGuardMachineToken)) {
                data.guard_data = details.steamGuardMachineToken;
            }
            else if (typeof details.steamGuardMachineToken == 'string' && (0, helpers_1.isJwtValidForAudience)(details.steamGuardMachineToken, 'machine')) {
                data.guard_data = Buffer.from(details.steamGuardMachineToken, 'utf8');
            }
        }
        let result = await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'BeginAuthSessionViaCredentials',
            apiVersion: 1,
            data
        });
        return {
            clientId: result.client_id,
            requestId: result.request_id,
            pollInterval: result.interval,
            allowedConfirmations: result.allowed_confirmations.map(c => ({ type: c.confirmation_type, message: c.associated_message })),
            steamId: result.steamid,
            weakToken: result.weak_token
        };
    }
    async startSessionWithQR() {
        let { deviceDetails } = this._getPlatformData();
        let data = {
            device_details: deviceDetails
        };
        let result = await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'BeginAuthSessionViaQR',
            apiVersion: 1,
            data
        });
        return {
            clientId: result.client_id,
            requestId: result.request_id,
            pollInterval: result.interval,
            allowedConfirmations: result.allowed_confirmations.map(c => ({ type: c.confirmation_type, message: c.associated_message })),
            challengeUrl: result.challenge_url,
            version: result.version
        };
    }
    async submitSteamGuardCode(details) {
        let data = {
            client_id: details.clientId,
            steamid: details.steamId,
            code: details.authCode,
            code_type: details.authCodeType
        };
        await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'UpdateAuthSessionWithSteamGuardCode',
            apiVersion: 1,
            data
        });
    }
    async checkMachineAuthOrSendCodeEmail(details) {
        let headers = Object.assign({ 'content-type': 'multipart/form-data' }, helpers_1.API_HEADERS);
        if (details.machineAuthToken) {
            headers.cookie = `steamMachineAuth${details.steamId}=${details.machineAuthToken}`;
        }
        let body = { clientid: details.clientId, steamid: details.steamId };
        debug('POST https://login.steampowered.com/jwt/checkdevice %o', body);
        let result = await this._webClient.request({
            method: 'POST',
            url: 'https://login.steampowered.com/jwt/checkdevice',
            multipartForm: http_1.HttpClient.simpleObjectToMultipartForm(body),
            headers: helpers_1.API_HEADERS
        });
        return result.jsonBody;
    }
    async pollLoginStatus(details) {
        let data = {
            client_id: details.clientId,
            request_id: details.requestId
        };
        let result = await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'PollAuthSessionStatus',
            apiVersion: 1,
            data
        });
        return {
            newClientId: result.new_client_id,
            newChallengeUrl: result.new_challenge_url,
            refreshToken: result.refresh_token,
            accessToken: result.access_token,
            hadRemoteInteraction: result.had_remote_interaction,
            accountName: result.account_name,
            newSteamGuardMachineAuth: result.new_guard_data
        };
    }
    async getAuthSessionInfo(accessToken, details) {
        let data = {
            client_id: details.clientId
        };
        let result = await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'GetAuthSessionInfo',
            apiVersion: 1,
            data,
            accessToken
        });
        return {
            ip: result.ip,
            geoloc: result.geoloc,
            city: result.city,
            state: result.state,
            platformType: result.platform_type,
            deviceFriendlyName: result.device_friendly_name,
            version: result.version,
            loginHistory: result.login_history,
            locationMismatch: result.requestor_location_mismatch,
            highUsageLogin: result.high_usage_login,
            requestedPersistence: result.requested_persistence
        };
    }
    async submitMobileConfirmation(accessToken, details) {
        let data = {
            version: details.version,
            client_id: details.clientId,
            steamid: details.steamId,
            signature: details.signature,
            confirm: details.confirm,
            persistence: details.persistence
        };
        await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'UpdateAuthSessionWithMobileConfirmation',
            apiVersion: 1,
            data,
            accessToken
        });
    }
    async generateAccessTokenForApp(refreshToken, renewRefreshToken = false) {
        let data = {
            refresh_token: refreshToken,
            steamid: (0, helpers_1.decodeJwt)(refreshToken).sub,
            renewal_type: renewRefreshToken ? ETokenRenewalType_1.default.Allow : ETokenRenewalType_1.default.None
        };
        let result = await this.sendRequest({
            apiInterface: 'Authentication',
            apiMethod: 'GenerateAccessTokenForApp',
            apiVersion: 1,
            data
        });
        // We're done with the transport
        this.close();
        return {
            accessToken: result.access_token,
            refreshToken: result.refresh_token || null
        };
    }
    async sendRequest(request) {
        // If a transport close is pending, cancel it
        (0, timers_1.clearTimeout)(this._transportCloseTimeout);
        // Right now we really only support IAuthenticationService
        let { request: requestProto, response: responseProto } = (0, protobufs_1.getProtoForMethod)(request.apiInterface, request.apiMethod);
        if (!requestProto || !responseProto) {
            throw new Error(`Unknown API method ${request.apiInterface}/${request.apiMethod}`);
        }
        let { headers } = this._getPlatformData();
        this.emit('debug', request.apiMethod, request.data, headers);
        let result = await this._transport.sendRequest({
            apiInterface: request.apiInterface,
            apiMethod: request.apiMethod,
            apiVersion: request.apiVersion,
            requestData: requestProto.encode(request.data).finish(),
            accessToken: request.accessToken,
            headers
        });
        if (result.result != EResult_1.default.OK) {
            throw (0, helpers_1.eresultError)(result.result, result.errorMessage);
        }
        // We need to decode the response data, if there was any
        let responseData = result.responseData && result.responseData.length > 0 ? result.responseData : Buffer.alloc(0);
        let decodedData = responseProto.decode(responseData);
        return responseProto.toObject(decodedData, { longs: String });
    }
    close() {
        // We might possibly want to immediately use this transport again after we think we should close it.
        // For example, to refresh a token after we log on. So instead of closing immediately, delay by 2 seconds
        // before closing to give us time for this possibility.
        (0, timers_1.clearTimeout)(this._transportCloseTimeout);
        this._transportCloseTimeout = setTimeout(() => {
            this._transport.close();
        }, 2000);
    }
    _getPlatformData() {
        switch (this._platformType) {
            case EAuthTokenPlatformType_1.default.SteamClient:
                let refererQuery = {
                    IN_CLIENT: 'true',
                    WEBSITE_ID: 'Client',
                    LOCAL_HOSTNAME: (0, helpers_1.getSpoofedHostname)(),
                    WEBAPI_BASE_URL: 'https://api.steampowered.com/',
                    STORE_BASE_URL: 'https://store.steampowered.com/',
                    USE_POPUPS: 'true',
                    DEV_MODE: 'false',
                    LANGUAGE: 'english',
                    PLATFORM: 'windows',
                    COUNTRY: 'US',
                    LAUNCHER_TYPE: '0',
                    IN_LOGIN: 'true'
                };
                return {
                    websiteId: 'Unknown',
                    // Headers are actually not used since this is sent over a CM connection
                    headers: {
                        'user-agent': 'Mozilla/5.0 (Windows; U; Windows NT 10.0; en-US; Valve Steam Client/default/1665786434; ) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.121 Safari/537.36',
                        origin: 'https://steamloopback.host',
                        referer: 'https://steamloopback.host/index.html?' + (0, querystring_1.stringify)(refererQuery)
                    },
                    // device_details is also not sent for SteamClient logins, matching the behavior of the official client
                    // in the past, the client did send these details, but not anymore
                    deviceDetails: {
                        device_friendly_name: refererQuery.LOCAL_HOSTNAME,
                        platform_type: EAuthTokenPlatformType_1.default.SteamClient,
                        os_type: EOSType_1.default.Win11,
                        // EGamingDeviceType full definition is unknown, but 1 appears to be a desktop PC
                        gaming_device_type: 1
                    }
                };
            case EAuthTokenPlatformType_1.default.WebBrowser:
                return {
                    websiteId: 'Community',
                    headers: {
                        'user-agent': this._webUserAgent,
                        origin: 'https://steamcommunity.com',
                        referer: 'https://steamcommunity.com'
                    },
                    // device details are sent for web logins
                    deviceDetails: {
                        device_friendly_name: this._webUserAgent,
                        platform_type: EAuthTokenPlatformType_1.default.WebBrowser
                    }
                };
            case EAuthTokenPlatformType_1.default.MobileApp:
                return {
                    websiteId: 'Mobile',
                    headers: {
                        'user-agent': 'okhttp/3.12.12',
                        cookie: 'mobileClient=android; mobileClientVersion=777777 3.0.0'
                    },
                    deviceDetails: {
                        device_friendly_name: 'Galaxy S22',
                        platform_type: EAuthTokenPlatformType_1.default.MobileApp,
                        os_type: EOSType_1.default.AndroidUnknown,
                        gaming_device_type: 528 // dunno
                    }
                };
            default:
                let err = new Error('Unsupported platform type');
                err.platformType = this._platformType;
                throw err;
        }
    }
}
exports.default = AuthenticationClient;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aGVudGljYXRpb25DbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvQXV0aGVudGljYXRpb25DbGllbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxtREFBb0Q7QUFDcEQsa0RBQWdDO0FBQ2hDLG1DQUFvQztBQUNwQyxtREFBc0Q7QUFDdEQsNkNBQTJEO0FBQzNELG1DQUFvQztBQUVwQyxrR0FBMEU7QUFDMUUsb0VBQTRDO0FBQzVDLG9FQUE0QztBQUM1Qyw0RkFBb0U7QUFDcEUsd0ZBQWdFO0FBRWhFLDJDQUE4QztBQUc5Qyx1Q0FPbUI7QUFnQ25CLE1BQU0sS0FBSyxHQUFHLElBQUEsZUFBVyxFQUFDLG9DQUFvQyxDQUFDLENBQUM7QUFVaEUsTUFBcUIsb0JBQXFCLFNBQVEscUJBQVk7SUFRN0QsWUFBWSxPQUErQztRQUMxRCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxVQUFVLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQztRQUNwQyxJQUFJLENBQUMsYUFBYSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7UUFDMUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDO1FBRXBDLElBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLFlBQVksQ0FBQztRQUMxQyxJQUFJLElBQUksQ0FBQyxhQUFhLElBQUksZ0NBQXNCLENBQUMsVUFBVSxFQUFFO1lBQzVELElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUM7U0FDakQ7UUFFRCxJQUFJLENBQUMsVUFBVSxHQUFHLE9BQU8sQ0FBQyxTQUFTLENBQUM7SUFDckMsQ0FBQztJQUVELEtBQUssQ0FBQyxTQUFTLENBQUMsV0FBbUI7UUFDbEMsT0FBTyxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUM7WUFDN0IsWUFBWSxFQUFFLGdCQUFnQjtZQUM5QixTQUFTLEVBQUUseUJBQXlCO1lBQ3BDLFVB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